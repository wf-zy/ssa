<template>
	<view class="container">
		<!-- é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
		<view class="profile-section">
			<view class="user-info-box">
				<view class="avatar-container" @click="changeAvatar">
					<image v-if="userInfo.avatar" :src="userInfo.avatar" class="avatar" />
					<view v-else class="avatar-placeholder">
						<text class="avatar-icon">ğŸ‘¤</text>
					</view>
				</view>
				<text class="username">{{ userInfo.nickname || 'æœªè®¾ç½®æ˜µç§°' }}</text>
				
				<!-- å¿«æ·æ“ä½œæŒ‰é’® -->
				<view class="quick-actions">
					<view class="quick-btn" @click="changeAvatar">
						<text class="quick-btn-text">æ›´æ¢å¤´åƒ</text>
					</view>
					<view class="quick-divider"></view>
					<view class="quick-btn" @click="changeNickname">
						<text class="quick-btn-text">ä¿®æ”¹æ˜µç§°</text>
					</view>
				</view>
			</view>
		</view>
		
		<!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
		<view class="info-section">
			<view class="info-item" @click="showPhoneActionSheet">
				<text class="info-label">æ‰‹æœºå·</text>
				<text class="info-value">{{ userInfo.phone || 'æœªç»‘å®š' }}</text>
				<text class="arrow">â€º</text>
			</view>
			
			<view class="info-item" @click="showPasswordActionSheet">
				<text class="info-label">å¯†ç </text>
				<text class="info-value">******</text>
				<text class="arrow">â€º</text>
			</view>
			
			<view class="info-item">
				<text class="info-label">æ³¨å†Œæ—¥æœŸ</text>
				<text class="info-value">{{ userInfo.registerDate || 'æœªçŸ¥' }}</text>
				<text class="arrow">â€º</text>
			</view>
		</view>
		
		<!-- é€šç”¨è®¾ç½®åŒºåŸŸ -->
		<view class="info-section">
			<view class="info-item">
				<text class="info-label">æ¶ˆæ¯é€šçŸ¥</text>
				<view class="info-value">
					<switch :checked="settings.notification" @change="toggleNotification" color="#546e7a" style="transform:scale(0.8)" />
				</view>
			</view>
			
			<view class="info-item" @click="clearCache">
				<text class="info-label">æ¸…é™¤ç¼“å­˜</text>
				<text class="info-value">{{ settings.cacheSize }}</text>
				<text class="arrow">â€º</text>
			</view>
			
			<view class="info-item" @click="showAbout">
				<text class="info-label">å…³äºæˆ‘ä»¬</text>
				<text class="info-value">v1.0.0</text>
				<text class="arrow">â€º</text>
			</view>
			
			<view class="info-item" @click="showPrivacy">
				<text class="info-label">éšç§æ”¿ç­–</text>
				<text class="info-value"></text>
				<text class="arrow">â€º</text>
			</view>
			
			<view class="info-item" @click="showAgreement">
				<text class="info-label">ç”¨æˆ·åè®®</text>
				<text class="info-value"></text>
				<text class="arrow">â€º</text>
			</view>
		</view>
		
		<!-- è´¦å·æ“ä½œåŒºåŸŸ -->
		<view class="account-section">
			<view class="account-item logout-item" @click="logout">
				<text class="account-text">é€€å‡ºè´¦å·</text>
			</view>
			<view class="account-item deactivate-item" @click="deactivateAccount">
				<text class="account-text">æ³¨é”€è´¦å·</text>
			</view>
		</view>
	</view>
</template>

<script>
	export default {
		data() {
			return {
				userInfo: {
					avatar: '', // å¯ä»¥æ˜¯é»˜è®¤å¤´åƒæˆ–ç”¨æˆ·ä¸Šä¼ çš„å¤´åƒè·¯å¾„
					nickname: 'æ¸¸å®¢',
					phone: '138****8888',
					registerDate: '2023-01-15'
				},
				settings: {
					notification: true,
					cacheSize: '12.5MB'
				}
			}
		},
		onLoad() {
			// é¡µé¢åŠ è½½æ—¶è·å–ç”¨æˆ·ä¿¡æ¯
			this.loadUserInfo();
			// è·å–ç¼“å­˜å¤§å°
			this.getCacheSize();
		},
		methods: {
			getCacheSize() {
				// æ¨¡æ‹Ÿè·å–ç¼“å­˜å¤§å°
				// å®é™…å¯ä»¥ä½¿ç”¨ uni.getStorageInfoSync().currentSize è®¡ç®—
				setTimeout(() => {
					this.settings.cacheSize = '12.5MB';
				}, 500);
			},
			toggleNotification(e : any) {
				this.settings.notification = e.detail.value;
				uni.showToast({
					title: this.settings.notification ? 'å·²å¼€å¯é€šçŸ¥' : 'å·²å…³é—­é€šçŸ¥',
					icon: 'none'
				});
			},
			clearCache() {
				uni.showModal({
					title: 'æç¤º',
					content: 'ç¡®å®šè¦æ¸…é™¤ç¼“å­˜å—ï¼Ÿ',
					success: (res) => {
						if (res.confirm) {
							uni.showLoading({
								title: 'æ¸…ç†ä¸­...'
							});
							setTimeout(() => {
								uni.hideLoading();
								this.settings.cacheSize = '0KB';
								uni.showToast({
									title: 'æ¸…é™¤æˆåŠŸ',
									icon: 'success'
								});
							}, 1500);
						}
					}
				});
			},
			showAbout() {
				uni.showModal({
					title: 'å…³äºæˆ‘ä»¬',
					content: 'SSAæ—…è¡ŒåŠ©æ‰‹ v1.0.0\n\nè‡´åŠ›äºä¸ºæ‚¨æä¾›æœ€ä¼˜è´¨çš„æ—…è¡Œè®¡åˆ’ä¸è®°å½•æœåŠ¡ã€‚',
					showCancel: false
				});
			},
			showPrivacy() {
				uni.showToast({
					title: 'è·³è½¬è‡³éšç§æ”¿ç­–',
					icon: 'none'
				});
			},
			showAgreement() {
				uni.showToast({
					title: 'è·³è½¬è‡³ç”¨æˆ·åè®®',
					icon: 'none'
				});
			},
			loadUserInfo() {
				// æ¨¡æ‹ŸåŠ è½½ç”¨æˆ·ä¿¡æ¯
				// åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™é‡Œåº”è¯¥æ˜¯ä»æœ¬åœ°å­˜å‚¨æˆ–æœåŠ¡å™¨è·å–ç”¨æˆ·ä¿¡æ¯
				const savedUserInfo = uni.getStorageSync('userInfo');
				if (savedUserInfo) {
					this.userInfo = savedUserInfo;
				}
			},
			changeAvatar() {
				// æ›´æ¢å¤´åƒåŠŸèƒ½
				uni.chooseImage({
					count: 1,
					sizeType: ['original', 'compressed'],
					sourceType: ['album', 'camera'],
					success: (res) => {
						this.userInfo.avatar = res.tempFilePaths[0];
						// ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
						uni.setStorageSync('userInfo', this.userInfo);
						
						uni.showToast({
							title: 'å¤´åƒæ›´æ¢æˆåŠŸ',
							icon: 'success'
						});
					},
					fail: () => {
						uni.showToast({
							title: 'å–æ¶ˆé€‰æ‹©',
							icon: 'none'
						});
					}
				});
			},
			changeNickname() {
				// ä¿®æ”¹æ˜µç§°åŠŸèƒ½
				uni.showModal({
					title: 'ä¿®æ”¹æ˜µç§°',
					placeholderText: 'è¯·è¾“å…¥æ–°æ˜µç§°',
					editable: true,
					success: (res) => {
						if (res.confirm && res.value) {
							this.userInfo.nickname = res.value;
							// ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
							uni.setStorageSync('userInfo', this.userInfo);
							
							uni.showToast({
								title: 'æ˜µç§°ä¿®æ”¹æˆåŠŸ',
								icon: 'success'
							});
						} else if (res.cancel) {
							uni.showToast({
								title: 'å·²å–æ¶ˆ',
								icon: 'none'
							});
						}
					}
				});
			},
			showPhoneActionSheet() {
				// æ˜¾ç¤ºæ‰‹æœºå·æ“ä½œé€‰é¡¹
				uni.showActionSheet({
					itemList: ['æŸ¥çœ‹æ‰‹æœºå·', 'æ›´æ¢æ‰‹æœºå·', 'è§£ç»‘æ‰‹æœºå·'],
					success: (res) => {
						if (res.tapIndex === 0) {
							uni.showToast({
								title: `æ‰‹æœºå·ï¼š${this.userInfo.phone}`,
								icon: 'none'
							});
						} else if (res.tapIndex === 1) {
							uni.showToast({
								title: 'æ›´æ¢æ‰‹æœºå·åŠŸèƒ½å¾…å®ç°',
								icon: 'none'
							});
						} else if (res.tapIndex === 2) {
							uni.showToast({
								title: 'è§£ç»‘æ‰‹æœºå·åŠŸèƒ½å¾…å®ç°',
								icon: 'none'
							});
						}
					}
				});
			},
			showPasswordActionSheet() {
				// æ˜¾ç¤ºå¯†ç æ“ä½œé€‰é¡¹
				uni.showActionSheet({
					itemList: ['ä¿®æ”¹å¯†ç ', 'å¿˜è®°å¯†ç ', 'å¯†ç å®‰å…¨'],
					success: (res) => {
						uni.showToast({
							title: 'å¯†ç ç›¸å…³åŠŸèƒ½å¾…å®ç°',
							icon: 'none'
						});
					}
				});
			},
			logout() {
				// é€€å‡ºè´¦å·åŠŸèƒ½
				uni.showModal({
					title: 'ç¡®è®¤é€€å‡º',
					content: 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
					success: (res) => {
						if (res.confirm) {
							// æ¸…é™¤ç”¨æˆ·ä¿¡æ¯
							uni.clearStorage();
							
							uni.showToast({
								title: 'å·²é€€å‡º',
								icon: 'success'
							});
							
							// å¯ä»¥åœ¨è¿™é‡Œè·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œå¦‚æœæœ‰çš„è¯
							// uni.redirectTo({
							// 	url: '/pages/login/login'
							// });
						}
					}
				});
			},
			deactivateAccount() {
				// æ³¨é”€è´¦å·åŠŸèƒ½
				uni.showModal({
					title: 'è­¦å‘Š',
					content: 'æ³¨é”€è´¦å·å°†æ°¸ä¹…åˆ é™¤æ‚¨çš„æ‰€æœ‰æ•°æ®ï¼Œä¸”æ— æ³•æ¢å¤ã€‚ç¡®å®šè¦æ³¨é”€å—ï¼Ÿ',
					confirmColor: '#ff4444',
					success: (res) => {
						if (res.confirm) {
							uni.showModal({
								title: 'è¯·è¾“å…¥å¯†ç ç¡®è®¤',
								placeholderText: 'è¯·è¾“å…¥å¯†ç ',
								editable: true,
								success: (pwdRes) => {
									if (pwdRes.confirm && pwdRes.value) {
										// è¿™é‡Œåº”è¯¥æœ‰éªŒè¯å¯†ç çš„é€»è¾‘
										console.log('ç”¨æˆ·è¾“å…¥çš„å¯†ç :', pwdRes.value);
										
										// æ¨¡æ‹Ÿæ³¨é”€è¿‡ç¨‹
										uni.showLoading({
											title: 'æ­£åœ¨æ³¨é”€...'
										});
										
										setTimeout(() => {
											uni.hideLoading();
											uni.showToast({
												title: 'è´¦å·å·²æ³¨é”€',
												icon: 'success'
											});
											
											// æ¸…é™¤æ‰€æœ‰ç”¨æˆ·æ•°æ®
											uni.clearStorage();
											
											// å¯ä»¥è·³è½¬åˆ°æ³¨å†Œé¡µé¢æˆ–ä¸»é¡µ
											// uni.reLaunch({
											// 	url: '/pages/index/index'
											// });
										}, 1500);
									}
								}
							});
						}
					}
				});
			}
		}
	}
</script>

<style>
	/* é¡µé¢æ•´ä½“æ ·å¼ */
	.container {
		display: flex;
		flex-direction: column;
		min-height: 100vh;
		background-color: #f5f5f5;
	}
	
	/* é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ */
	.profile-section {
		background-color: #e3f2fd;
		padding: 60rpx 40rpx 40rpx;
		text-align: center;
		margin-bottom: 20rpx;
		border-bottom-left-radius: 30rpx;
		border-bottom-right-radius: 30rpx;
	}
	
	.user-info-box {
		display: flex;
		flex-direction: column;
		align-items: center;
	}
	
	.avatar-container {
		margin: 0 auto 20rpx;
	}
	
	.avatar {
		width: 140rpx;
		height: 140rpx;
		border-radius: 50%;
		border: 6rpx solid #ffffff;
		object-fit: cover;
		box-shadow: 0 4rpx 12rpx rgba(0,0,0,0.1);
	}
	
	.avatar-placeholder {
		width: 140rpx;
		height: 140rpx;
		border-radius: 50%;
		border: 6rpx solid #ffffff;
		background-color: #f0f0f0;
		display: flex;
		justify-content: center;
		align-items: center;
		box-shadow: 0 4rpx 12rpx rgba(0,0,0,0.1);
	}
	
	.avatar-icon {
		font-size: 70rpx;
		color: #aaa;
	}
	
	.username {
		font-size: 40rpx;
		font-weight: bold;
		color: #333;
		display: block;
		margin-top: 10rpx;
		margin-bottom: 30rpx;
	}
	
	/* å¿«æ·æ“ä½œæŒ‰é’® */
	.quick-actions {
		display: flex;
		flex-direction: row;
		justify-content: center;
		align-items: center;
		width: 100%;
		padding-top: 20rpx;
	}
	
	.quick-btn {
		flex: 1;
		display: flex;
		justify-content: center;
		align-items: center;
		padding: 10rpx 0;
	}
	
	.quick-btn:active {
		opacity: 0.7;
	}
	
	.quick-btn-text {
		font-size: 28rpx;
		color: #546e7a;
		font-weight: 500;
	}
	
	.quick-divider {
		width: 2rpx;
		height: 30rpx;
		background-color: #b0bec5;
		margin: 0 30rpx;
	}
	
	/* ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ */
	.info-section {
		background-color: #ffffff;
		margin: 20rpx 20rpx;
		border-radius: 16rpx;
		overflow: hidden;
		box-shadow: 0 2rpx 10rpx rgba(0,0,0,0.05);
	}

	.info-item {
		display: flex;
		flex-direction: row;
		justify-content: space-between;
		align-items: center;
		padding: 30rpx 40rpx;
		border-bottom: 1rpx solid #f0f0f0;
	}

	.info-item:last-child {
		border-bottom: none;
	}

	.info-label {
		font-size: 30rpx;
		color: #333;
		text-align: left;
		min-width: 120rpx;
	}

	.info-value {
		font-size: 28rpx;
		color: #666;
		margin-left: 20rpx;
		flex: 1;
		text-align: right;
		display: flex;
		justify-content: flex-end;
		align-items: center;
	}
	
	.arrow {
		font-size: 36rpx;
		color: #ccc;
		margin-left: 10rpx;
	}
	
	/* è´¦å·æ“ä½œåŒºåŸŸ */
	.account-section {
		flex: 1;
		display: flex;
		flex-direction: column;
		justify-content: flex-end;
		padding: 0 40rpx 40rpx;
		gap: 20rpx;
	}

	.account-item {
		height: 80rpx;
		border-radius: 12rpx;
		font-size: 30rpx;
		display: flex;
		justify-content: center;
		align-items: center;
		border: none;
	}

	.logout-item {
		background-color: #ffffff;
		color: #333;
		border: 1rpx solid #ddd;
	}

	.deactivate-item {
		background-color: #ff4444;
		color: #ffffff;
	}

	.account-text {
		font-size: 30rpx;
		color: inherit;
		text-align: center;
	}
</style>